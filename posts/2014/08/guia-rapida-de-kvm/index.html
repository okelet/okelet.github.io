<!doctype html><html lang=es-es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.7.0"><meta name=author content="Juan Asensio"><meta name=description content="De la 
Wikipedia:

Kernel-based Virtual Machine o KVM, (en español, Máquina virtual basada en el núcleo) es una solución para implementar virtualización completa con Linux. Está formada por un módulo del núcleo (con el nombre kvm.ko) y herramientas en el espacio de usuario, siendo en su totalidad software libre. El componente KVM para el núcleo está incluido en Linux desde la versión 2.6.20.


KVM permite ejecutar máquinas virtuales utilizando imágenes de disco que contienen sistemas operativos sin modificar. Cada máquina virtual tiene su propio hardware virtualizado: una tarjeta de red, discos duros, tarjeta gráfica, etc.

En primer lugar, debemos comprobar si nuestro equipo es compatible con KVM:
egrep --color '(svm|vmx)' /proc/cpuinfo

Si la salida anterior muestra algo, podremos seguir adelante. Si no muestra nada, también podremos seguir, pero no se aprovecharán las capacidades de virtualización del equipo (se hará un 
fallback a emulación en lugar de virtualización)."><link rel=alternate hreflang=es-es href=https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/><meta name=theme-color content="#2962ff"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53728915-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
function trackOutboundLink(url,target){gtag('event','click',{'event_category':'outbound','event_label':url,'transport_type':'beacon','event_callback':function(){if(target!=='_blank'){document.location=url;}}});console.debug("Outbound link clicked: "+url);}
function onClickCallback(event){if((event.target.tagName!=='A')||(event.target.host===window.location.host)){return;}
trackOutboundLink(event.target,event.target.getAttribute('target'));}
gtag('js',new Date());gtag('config','UA-53728915-2',{'anonymize_ip':true});document.addEventListener('click',onClickCallback,false);</script><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png><link rel=canonical href=https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/><meta property="twitter:card" content="summary"><meta property="og:site_name" content="Mis notas"><meta property="og:url" content="https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/"><meta property="og:title" content="Guía rápida de KVM | Mis notas"><meta property="og:description" content="De la 
Wikipedia:

Kernel-based Virtual Machine o KVM, (en español, Máquina virtual basada en el núcleo) es una solución para implementar virtualización completa con Linux. Está formada por un módulo del núcleo (con el nombre kvm.ko) y herramientas en el espacio de usuario, siendo en su totalidad software libre. El componente KVM para el núcleo está incluido en Linux desde la versión 2.6.20.


KVM permite ejecutar máquinas virtuales utilizando imágenes de disco que contienen sistemas operativos sin modificar. Cada máquina virtual tiene su propio hardware virtualizado: una tarjeta de red, discos duros, tarjeta gráfica, etc.

En primer lugar, debemos comprobar si nuestro equipo es compatible con KVM:
egrep --color '(svm|vmx)' /proc/cpuinfo

Si la salida anterior muestra algo, podremos seguir adelante. Si no muestra nada, también podremos seguir, pero no se aprovecharán las capacidades de virtualización del equipo (se hará un 
fallback a emulación en lugar de virtualización)."><meta property="og:image" content="img/map[gravatar:%!s(bool=false) shape:circle]"><meta property="twitter:image" content="img/map[gravatar:%!s(bool=false) shape:circle]"><meta property="og:locale" content="es-es"><meta property="article:published_time" content="2014-08-12T13:12:48+02:00"><meta property="article:modified_time" content="2014-08-12T13:12:48+02:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/"},"headline":"Guía rápida de KVM","datePublished":"2014-08-12T13:12:48+02:00","dateModified":"2014-08-12T13:12:48+02:00","author":{"@type":"Person","name":"Juan Asensio"},"publisher":{"@type":"Organization","name":"Mis notas","logo":{"@type":"ImageObject","url":"https://blog.okelet.com/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png"}},"description":"\u003cp\u003eDe la \n\u003ca href=\"http://es.wikipedia.org/wiki/Kernel-based_Virtual_Machine\" target=\"_blank\" rel=\"noopener\"\u003eWikipedia\u003c/a\u003e:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eKernel-based Virtual Machine o KVM, (en español, Máquina virtual basada en el núcleo) es una solución para implementar virtualización completa con Linux. Está formada por un módulo del núcleo (con el nombre kvm.ko) y herramientas en el espacio de usuario, siendo en su totalidad software libre. El componente KVM para el núcleo está incluido en Linux desde la versión 2.6.20.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cblockquote\u003e\n\u003cp\u003eKVM permite ejecutar máquinas virtuales utilizando imágenes de disco que contienen sistemas operativos sin modificar. Cada máquina virtual tiene su propio hardware virtualizado: una tarjeta de red, discos duros, tarjeta gráfica, etc.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eEn primer lugar, debemos comprobar si nuestro equipo es compatible con KVM:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-bash\"\u003eegrep --color '(svm|vmx)' /proc/cpuinfo\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eSi la salida anterior muestra algo, podremos seguir adelante. Si no muestra nada, también podremos seguir, pero no se aprovecharán las capacidades de virtualización del equipo (se hará un \n\u003ca href=\"http://blog.vmsplice.net/2011/03/should-i-use-qemu-or-kvm.html\" target=\"_blank\" rel=\"noopener\"\u003e\u003cem\u003efallback\u003c/em\u003e\u003c/a\u003e a emulación en lugar de virtualización).\u003c/p\u003e"}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#2962ff","text":"#fff"},"button":{"background":"#fff","text":"#2962ff"}},"theme":"classic","content":{"message":"Este sitio web utiliza cookies para garantizarle una mejor experiencia.","dismiss":"¡Entendido!","link":"Más información","href":"https://www.cookiesandyou.com"}})});</script><script src=https://identity.netlify.com/v1/netlify-identity-widget.js></script><title>Guía rápida de KVM | Mis notas</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Buscar</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Buscar... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Mis notas</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Barra de navegación">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Mis notas</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class="nav-link active" href=/><span>Inicio</span></a></li><li class=nav-item><a class=nav-link href=/post/><span>Archivos</span></a></li><li class=nav-item><a class=nav-link href=/tags/><span>Tags</span></a></li><li class=nav-item><a class=nav-link href=/projects/><span>Proyectos</span></a></li><li class=nav-item><a class=nav-link href=/index.xml><span>RSS</span></a></li><li class=nav-item><a class=nav-link href=/authors/okelet/><span>Acerca de</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-dark-toggle" href=#><i class="fas fa-moon" aria-hidden=true></i></a></li></ul></div></nav><article class=article><div class="article-container pt-3"><h1>Guía rápida de KVM</h1><div class=article-metadata><span class=article-date>Tue, 12 Aug 2014</span>
<span class=middot-divider></span><span class=article-reading-time>12 min de lectura</span>
<span class=middot-divider></span><a href=/posts/2014/08/guia-rapida-de-kvm/#disqus_thread></a></div></div><div class=article-container><div class=article-style><p>De la
<a href=http://es.wikipedia.org/wiki/Kernel-based_Virtual_Machine target=_blank rel=noopener>Wikipedia</a>:</p><blockquote><p>Kernel-based Virtual Machine o KVM, (en español, Máquina virtual basada en el núcleo) es una solución para implementar virtualización completa con Linux. Está formada por un módulo del núcleo (con el nombre kvm.ko) y herramientas en el espacio de usuario, siendo en su totalidad software libre. El componente KVM para el núcleo está incluido en Linux desde la versión 2.6.20.</p></blockquote><blockquote><p>KVM permite ejecutar máquinas virtuales utilizando imágenes de disco que contienen sistemas operativos sin modificar. Cada máquina virtual tiene su propio hardware virtualizado: una tarjeta de red, discos duros, tarjeta gráfica, etc.</p></blockquote><p>En primer lugar, debemos comprobar si nuestro equipo es compatible con KVM:</p><pre><code class=language-bash>egrep --color '(svm|vmx)' /proc/cpuinfo
</code></pre><p>Si la salida anterior muestra algo, podremos seguir adelante. Si no muestra nada, también podremos seguir, pero no se aprovecharán las capacidades de virtualización del equipo (se hará un
<a href=http://blog.vmsplice.net/2011/03/should-i-use-qemu-or-kvm.html target=_blank rel=noopener><em>fallback</em></a> a emulación en lugar de virtualización).</p><h2 id=instalación-en-debianubuntu>Instalación en Debian/Ubuntu</h2><p>Para Debian/Ubuntu, deberemos instalar los siguientes paquetes:</p><pre><code class=language-bash>sudo apt-get install cpu-checker qemu-kvm libvirt-bin bridge-utils virt-manager virt-viewer libguestfs-tools
</code></pre><p>También tendremos que añadir nuestro usuario al grupo <code>libvirtd</code> para poder gestionar máquinas virtuales en el sistema con nuestro propio usuario (sin ser root):</p><pre><code class=language-bash>sudo adduser ${USER} libvirtd
</code></pre><p>Por último, deberemos reiniciar la sesión para que se recarguen nuestros permisos de usuario.</p><h2 id=instalación-en-red-hatcentos>Instalación en Red Hat/CentOS</h2><p>Para Red Hat/CentOS, deberemos instalar los siguientes paquetes:</p><pre><code class=language-bash>sudo yum install kvm libvirt virt-viewer virt-manager virt-sysprep
</code></pre><p>Para poder gestionar máquinas virtuales sin necesidad de ser root, deberemos crear un grupo, agregar nuestro usuario a ese grupo, y configurar ese grupo en KVM para permitirle la gestión (básicamente, estamos simulando el comportamiento que Ubuntu ya hace por sí solo,
<a href=http://n40lab.wordpress.com/2012/10/03/installing-kvm-with-yum-and-compiling-libvirt-and-virtmanager/ target=_blank rel=noopener>referencia 1</a> y
<a href=http://www.opennet.ru/openforum/vsluhforumID1/93974.html target=_blank rel=noopener>referencia 2</a>):</p><pre><code class=language-bash>sudo groupadd libvirtd
sudo usermod -a -G libvirtd ${USER}
sudo sed -r -i -e 's/^#?unix_sock_group = .*/unix_sock_group = &quot;libvirtd&quot;/' \
               -e 's/^#?unix_sock_rw_perms = .*/unix_sock_rw_perms = &quot;0770&quot;/' \
               -e 's/^#?auth_unix_rw = .*/auth_unix_rw = &quot;none&quot;/' \
               /etc/libvirt/libvirtd.conf
sudo service libvirtd restart
</code></pre><p>Por último, deberemos reiniciar la sesión para que se recarguen nuestros permisos de usuario.</p><h2 id=herramientas-principales-de-gestión>Herramientas principales de gestión</h2><p>Con KVM disponemos de varias herramientas para gestionar tanto el sistema como las propias máquinas virtuales:</p><ul><li><code>virsh</code>: nos permite gestionar el sistema y las máquinas virtuales a un nivel medio-bajo.</li><li><code>virt-install</code>: nos permite crear máquinas virtuales de una forma sencilla.</li></ul><h2 id=tipos-de-conexión>Tipos de conexión</h2><p>En la instalación por defecto, tenemos dos tipos de conexión:</p><ul><li><code>qemu:///system</code>: nos conectamos al servicio de virtualización del sistema. Las máquinas creadas aquí se pueden configurar para que arranquen automáticamente cuando se inicie el host.</li><li><code>quemu:///session</code>: nos conectamos a nuestra propia sesión. Estas máquinas sólo las podrá ver y gestionar el propio usuario, y además, los archivos de imagen (discos duros, etc.), deberán estar en una ubicación donde el usuario pueda leer y escribir (en la ruta por efecto <code>/var/lib/libvirt/images</code> sólo puede escribir cuando nos conectamos a la URL de sistema).</li></ul><p>Según las pruebas que he hecho, los comandos <code>virsh</code> y <code>virt-instal</code> (explicados en la siguiente sección) se comportan de manera distinta a la hora de conectarse. <code>virsh</code> por defecto se conecta a <code>quemu:///system</code>, mientras que <code>virt-install</code> se conecta a <code>quemu:///session</code>. Por esto, en los siguientes ejemplos, se especifica siempre como URL de conexión <code>quemu:///system</code>, ya que las imágenes de disco se van a crear en <code>/var/lib/libvirt/images</code>. Si no especificásemos URL de conexión, o pusiéramos la de sesión del usuario, deberíamos establecer una ruta de imagen de disco donde el propio usuario pueda escribir, como <code>${HOME}</code>.</p><h2 id=instalación-de-virt-manager-actualizado>Instalación de virt-manager actualizado</h2><p>Uso Ubuntu 13.10 y la versión en los repositorios es la 0.9.5. La última versión de <code>virt-manager</code> es la 1.0.1, pero no está en los repositorios para esta versión de Ubuntu (aunque sí a partir de la 14.04); esta última versión tiene bastantes mejoras, entre ellas, la
<a href=http://virt-manager.org/download/ target=_blank rel=noopener>gestión de snapshots</a>. Para instalar la nueva versión no hay más que descargarse el fuente (está escrita en Python); no hay que compilar ni instalar como root (se pueden tener las 2 versiones de <code>virt-manager</code>, la de los repositorios y la instalada a mano, pero hay que tener cuidado con cuál ejecutamos para no volverse uno loco).</p><p>En primer lugar, tenemos que descargar una serie de dependencias adicionales que necesitamos (referencias
<a href=http://www.gravitycomputing.co.nz/virt-manager-1-01-debian/ target=_blank rel=noopener>uno</a> y
<a href=http://askubuntu.com/questions/340937/virtmanager-0-95-or-0-10-on-ubuntu-and-cannot-import-name-gtkvnc target=_blank rel=noopener>dos</a>):</p><pre><code class=language-bash>sudo apt-get install gir1.2-spice-client-gtk-3.0 python-gtk-vnc libglib2.0-bin python-ipaddr libvirt-glib-1.0-dev gir1.2-gtk-vnc-2.0
</code></pre><p>En principio esto también valdría para Red Hat/CentOS, pero no he encontrado el paquete necesario para la dependencia <code>gi.repository</code> en CentOS 6, y no he podido hacerlo funcionar.</p><pre><code class=language-bash>yum install python-argparse ...
</code></pre><p>Después de instalar las dependencias, nos bajamos el paquete fuente, lo descomprimimos y lo ejecutamos:</p><pre><code class=language-bash>wget http://virt-manager.org/download/sources/virt-manager/virt-manager-1.0.1.tar.gz -O - | tar -xz
cd virt-manager-1.0.1
./virt-manager
</code></pre><h2 id=comandos-útiles>Comandos útiles</h2><p>Mostrar la lista de máquinas en ejecución en el sistema:</p><pre><code class=language-bash>virsh -c qemu:///system list
</code></pre><p>Mostrar todas las máquinas configuradas en el sistema:</p><pre><code class=language-bash>virsh -c qemu:///system list --all
</code></pre><p>En los comandos anteriores, podemos sustituir <code>qemu:///system</code> por <code>quemu:///session</code> para ver las máquinas asociadas a nuestro usuario (ver apartado anterior).</p><p>Mostrar lista de tipos de sistemas operativos; esto es necesario saberlo para cuando vayamos a instalar una máquina con <code>virt-install</code>, ya que deberemos especificar el tipo en el momento de la creación:</p><pre><code class=language-bash>virt-install --os-variant list
</code></pre><p>Parar <em>a lo bruto</em> una máquina:</p><pre><code class=language-bash>virsh destroy nombre_maquina
</code></pre><p>Eliminar una máquina y todos sus ficheros asociados (snapshots, ficheros de disco, etc.):</p><pre><code class=language-bash>virsh undefine --managed-save --snapshots-metadata --remove-all-storage nombre_maquina
</code></pre><h2 id=creación-rápida-de-máquinas-comunes>Creación rápida de máquinas comunes</h2><p>CentOS 5 32 bits:</p><pre><code class=language-bash>virt-install --connect qemu:///system -n centos5x32 -r 512 --vcpus=1 --os-variant=rhel5.4 \
--graphics spice --disk path=/var/lib/libvirt/images/centos5x32.qcow2,format=qcow2,size=8 \
-l http://sunsite.rediris.es/mirror/CentOS/5/os/i386 \
-x &quot;lang=es_ES keyboard=es&quot;
</code></pre><p>CentOS 5 64 bits:</p><pre><code class=language-bash>virt-install --connect qemu:///system -n centos5x64 -r 512 --vcpus=1 --os-variant=rhel5.4 \
--graphics spice --disk path=/var/lib/libvirt/images/centos5x64.qcow2,format=qcow2,size=8 \
-l http://sunsite.rediris.es/mirror/CentOS/5/os/x86_64 \
-x &quot;lang=es_ES keyboard=es&quot;
</code></pre><p>CentOS 6 32 bits:</p><pre><code class=language-bash>virt-install --connect qemu:///system -n centos6x32 -r 1024 --vcpus=1 --os-variant=rhel6 \
--graphics spice --disk path=/var/lib/libvirt/images/centos6x32.qcow2,format=qcow2,size=8 \
-l http://sunsite.rediris.es/mirror/CentOS/6/os/i386 \
-x &quot;lang=es_ES keyboard=es&quot;
</code></pre><p>CentOS 6 64 bits:</p><pre><code class=language-bash>virt-install --connect qemu:///system -n centos6x64 -r 1024 --vcpus=1 --os-variant=rhel6 \
--graphics spice --disk path=/var/lib/libvirt/images/centos6x64.qcow2,format=qcow2,size=8 \
-l http://sunsite.rediris.es/mirror/CentOS/6/os/x86_64 \
-x &quot;lang=es_ES keyboard=es&quot;
</code></pre><p>CentOS 7 64 bits (
<a href=https://access.redhat.com/solutions/509373 target=_blank rel=noopener>no existe versión de 32 bits</a>):</p><pre><code class=language-bash>virt-install --connect qemu:///system -n centos7x64 -r 1024 --vcpus=1 --os-variant=rhel7 \
--graphics spice --disk path=/var/lib/libvirt/images/centos7x64.qcow2,format=qcow2,size=8 \
-l http://sunsite.rediris.es/mirror/CentOS/7/os/x86_64 \
-x &quot;lang=es_ES keyboard=es&quot;
</code></pre><p>Debian 7 32 bits:</p><pre><code class=language-bash>virt-install --connect qemu:///system -n debian7x32 -r 512 --vcpus 1 --os-variant debianwheezy \
--graphics spice --disk path=/var/lib/libvirt/images/debian7x32.qcow2,format=qcow2,size=8 \
-l http://ftp.debian.org/debian/dists/wheezy/main/installer-i386/ \
-x &quot;language=es country=ES debian-installer/locale=es_ES.UTF-8 keyboard-configuration/xkb-keymap=es\
    time/zone=Europe/Madrid passwd/make-user=false&quot;
</code></pre><p>Debian 7 64 bits:</p><pre><code class=language-bash>virt-install --connect qemu:///system -n debian7x64 -r 512 --vcpus 1 --os-variant debianwheezy \
--graphics spice --disk path=/var/lib/libvirt/images/debian7x64.qcow2,format=qcow2,size=8 \
-l http://ftp.debian.org/debian/dists/wheezy/main/installer-amd64/ \
-x &quot;language=es country=ES debian-installer/locale=es_ES.UTF-8 keyboard-configuration/xkb-keymap=es \
    time/zone=Europe/Madrid passwd/make-user=false&quot;
</code></pre><p>Los comandos anteriores tienen el parámetro <code>-x</code> (<code>--extra-args</code>). Estos parámetros se pasan automáticamente al kernel de arranque de instalación del sistema operativo. Con ellos, podemos configurar automáticamente ciertos parámetros que se nos pide durante la instalación (los más usados en los ejemplos anteriores sirven para configurar el idioma, la localización, la distribución del teclado, la zona horaria, o incluso si crear o no un usuario regular en el sistema). También es posible pasar una ruta a un fichero KickStart (Red Hat/CentOS) o Preseed (Debian/Ubuntu) para automatizar completamente la instalación. Más información:</p><ul><li>Red Hat/CentOS: parámetros de arranque
<a href=https://www.centos.org/docs/5/html/Installation_Guide-en-US/ch-bootopts-x86.html target=_blank rel=noopener>uno</a> y
<a href=https://www.centos.org/docs/5/html/installation_Guide-en-US/s1-kickstart2-options.html target=_blank rel=noopener>dos</a>,
<a href=http://fedoraproject.org/wiki/Anaconda/Kickstart target=_blank rel=noopener>Kickstart</a></li><li>Debian/Ubuntu:
<a href=https://www.debian.org/releases/stable/i386/ch05s03.html.en target=_blank rel=noopener>parámetros de arranque</a>,
<a href=https://wiki.debian.org/DebianInstaller/ target=_blank rel=noopener>Preseed</a></li></ul><p>Para especificar un proxy de instalación en los casos anteriores, se deben especificar las siguientes opciones:</p><ul><li>Para Debian/Ubuntu: <code>mirror/http/proxy=http://[usuario:contraseña@]proxy.dominio.com:3128/</code></li><li>Para CentOS/Red Hat: <code>proxy=http://[usuario:contraseña@]proxy.dominio.com:3128/</code></li></ul><p>La opción <code>--graphics spice</code> especificada en los comandos anteriores permite una mejor calidad y mayor rendimiento de los gráficos en la máquina virtual, usando el driver <code>qxl</code>, así como una mejor integración con el host a través del protocolo
<a href=http://spice-space.org target=_blank rel=noopener>Spice</a>, permitiendo el cambio de resolución de la máquina virtual según redimensionemos el visor, redirección del sonido, copiar y pegar, etc. En caso de que no se especifique esta opción se usaría una comunicación mediante VNC y un driver Cirrus. Para que el protocolo Spice funcion correctamente en la máquina virtual, deberemos asegurarnos que está instalado el driver gráfico adecuado y el agente de Spice, según lo indicado en el siguiente apartado.</p><h2 id=cambiar-cirrusvnc-por-qxlspice>Cambiar Cirrus/VNC por QXL/Spice</h2><p>Como he comentando antes, el protocolo Spice ofrece un rendimiento mayor y mejor integración con el huésped. Si tenemos alguna máquina virtual creada con las opciones por defecto, podemos actualizarla cambiando las opciones adecuadas. Para ello, con la máquina virtual parada, editaremos su configuración XML y mofificaremos los bloques especificados a continuación:</p><pre><code class=language-bash>virsh edit nombre_maquina
</code></pre><pre><code class=language-xml>    &lt;channel type='spicevmc'&gt;
      &lt;target type='virtio' name='com.redhat.spice.0'/&gt;
      &lt;address type='virtio-serial' controller='0' bus='0' port='1'/&gt;
    &lt;/channel&gt;
    &lt;graphics type='spice' autoport='yes'/&gt;
    &lt;video&gt;
      &lt;model type='qxl' ram='65536' vram='65536' heads='1'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/&gt;
    &lt;/video&gt;
</code></pre><p>Tras esto, ya podemos arrancar la máquina virtual y debemos asegurarnos de tener instalado tanto el driver gráfico correspondiente, como el agente de Spice. Para ello, ejecutaremos los siguientes comandos en distribuciones Debian/Ubuntu:</p><pre><code class=language-bash>sudo apt-get install xserver-xorg-video-qxl spice-vdagent
sudo update-rc.d spice-vdagent defaults
sudo service spice-vdagent start
</code></pre><p>Estos otros en distribuciones Red Hat/CentOS con SysV (versiones 6 y anteriores):</p><pre><code class=language-bash>sudo yum install xorg-x11-drv-qxl spice-vdagent
sudo chkconfig spice-vdagentd on
sudo service spice-vdagentd start
</code></pre><p>Y estos otros en distribuciones Red Hat/CentOS con Systemd (versiones 7 y posteriores):</p><pre><code class=language-bash>sudo yum install xorg-x11-drv-qxl spice-vdagent
sudo systemctl enable spice-vdagentd
sudo systemctl start spice-vdagentd
</code></pre><p>Para finalizar, deberemos reiniciar la máquina virtual para que se apliquen los cambios.</p><h2 id=intercambiar-entre-kvm-y-virtualbox>Intercambiar entre KVM y VirtualBox</h2><p>Si se tiene instalado VirtualBox, KVM no se ejecutará con todas las características de virtualización completas, sino que delegará en QEMU (que es mucho más lento), o bien VirtualBox no se ejecutará diciendo que no se han podido cargar sus módulos (
<a href=http://www.dedoimedo.com/computers/kvm-virtualbox.html target=_blank rel=noopener>dependiendo del orden de carga de los módulos de KVM o VirtualBox, será uno u otro el que no funcione</a>). Para solventar esto, o bien debemos desinstalar uno de los dos sistemas, o bien debemos desactivar los módulos del otro cuando vayamos a ejecutar un sistema de virtualización.</p><p>Para usar KVM:</p><pre><code class=language-bash>sudo /etc/init.d/vboxdrv stop
sudo modprobe kvm
sudo modprobe kvm_intel
</code></pre><p>Para usar VirtualBox:</p><pre><code class=language-bash>sudo modprobe -r kvm_intel
sudo modprobe -r kvm
sudo /etc/init.d/vboxdrv start
</code></pre><p>En mi caso, que tengo en el trabajo un Dell OptiPlex 755, hay que tocar algunas cosas en la BIOS para que funcione correctamente KVM, ya que cuando intentaba cargar el módulo <code>kvm_intel</code> me daba un error de <code>Operation not supported</code>. En esta
<a href=http://serverfault.com/questions/534934/vt-enabled-in-bios-but-kvm-failed-to-detect target=_blank rel=noopener>pregunta de serverfault</a>, que a su vez
<a href=http://reidablog.blogspot.com.es/2008/06/with-correct-bios-settings-enabled-on.html target=_blank rel=noopener>hace referencia a ésta</a>, indican las opciones de la BIOS que se deben poner para que funcione; en resumen:</p><ul><li>Security: Execute Disable should be On</li><li>Performance: Virtualization should be On</li><li>Performance: VT for Direct I/O Access should be On</li><li>Performance: Trusted Execution should be Off</li></ul><h2 id=snapshots>Snapshots</h2><p>Para poder tomar snapshots, el formato de los discos debe ser alguno que sea compatible; si al crear la máquina, no se especifica uno, se crearán con el formato <code>raw</code>, que no los permite; por eso, en todos los comandos anteriores se usa el formato <code>qcow2</code>.</p><p>Mostrar los snapshots de una máquina:</p><pre><code class=language-bash>virsh snapshot-list nombre_maquina
</code></pre><p>Tomar un snapshot de una máquina:</p><pre><code class=language-bash>virsh snapshot-create-as nombre_maquina &quot;Nombre del snapshot (opcional)&quot; &quot;Descripción del snapshot (opcional)&quot;
</code></pre><p>Revertir a un snapshot anterior:</p><pre><code class=language-bash>virsh snapshot-revert nombre_maquina [nombre_snapshot|--current]
</code></pre><p>Eliminar un snapshot:</p><pre><code class=language-bash>virsh snapshot-delete nombre_maquina [nombre_snapshot|--current] [{--children | --children-only}]
</code></pre><h2 id=convertir-imágenes-de-disco-a-qcow2>Convertir imágenes de disco a QCOW2</h2><p>En caso de que tengamos una máquina virtual con un disco en formato <code>raw</code>, no podremos utilizar la funcionalidad de snapshots, como hemos comentado antes. Para solucionar esto, deberemos convertir el fichero de imagen de la máquina a formato <code>qcow2</code>, y luego editar la configuración de la máquina virtual para decirle que hemos cambiado el formato del disco.</p><p>Para convertir el formato (se debe hacer con la máquina apagada, y con <code>sudo</code> ya que necesita acceder directamente al disco para leerlo y luego poder crear el nuevo):</p><pre><code class=language-bash>sudo qemu-img convert -f raw -O qcow2 /var/lib/libvirt/images/centos7x64.{img,qcow2}
</code></pre><p>Tras esto, debemos reconfigurar la máquina virtual para indicar el nuevo nombre del fichero y formato del disco (al igual que antes, con la máquina apagada):</p><pre><code class=language-bash>virsh edit centos7x64
</code></pre><pre><code class=language-xml>    &lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='qcow2'/&gt;
      &lt;source file='/var/lib/libvirt/images/centos7x64.qcow2'/&gt;
      &lt;target dev='vda' bus='virtio'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/&gt;
    &lt;/disk&gt;
</code></pre><h2 id=clonar-máquinas-virtuales>Clonar máquinas virtuales</h2><p>A la hora de clonar máquinas virtuales debemos tener en cuenta varias cosas:</p><ul><li>Se debe duplicar el disco</li><li>Se debe generar una nueva dirección MAC para cada una de las tarjetas de red</li><li>A nivel de sistema operativo:<ul><li>Cambiar la dirección MAC con la nueva en los archivos de configuración (<code>/etc/sysconfig/network-scripts/ifcfg-eth*</code> en Red Hat/CentOS)</li><li>Se deben eliminar y regerenerar las claves SSH antiguas</li><li>Se deberían eliminar los usuarios del sistema original</li></ul></li><li>Y cualquier cosa más que se nos ocurra</li></ul><p>Para realizar todas estas tareas, disponemos principalmente de 2 herramientas:</p><ul><li><code>virt-clone</code>: realiza el clonado en sí de la máquina, copiando el disco, y cambiando las direcciones MAC de las tarjetas (a nivel de KVM sólo, no a nivel del sistema operativo virtual).</li><li><code>virt-sysprep</code>: permite realizar modificaciones en el sistema operativo para configurarlo correctamente con las nuevas especificaciones (MAC, SSH, etc.).</li></ul><p>Desde la aplicación <code>virt-manager</code> es bastante sencillo, pues se realiza en apenas 2 clicks por la interfaz gráfica. Para hacerlo por comandos, realizaremos los siguientes pasos. En primer lugar, clonaremos la máquina en sí (si no especificamos manualmente un disco de destino con la opción <code>--file</code>, se nos creará uno automáticamente con el nombre de a nueva máquina; si no especificamos tampoco una MAC manualmente con el parámetro <code>--mac</code>, se generará una aleatoria automáticamente):</p><pre><code class=language-bash>virt-clone --connect qemu:///system --original centos6x32 --auto-clone --name centos6x32-clone
</code></pre><p>Tras esto, ejecuataremos (<code>virt-sysprep</code> se tiene que ejecutar con <code>sudo</code> o dar permisos de lectura y escritura al usuario actual sobre el archivo de imagen de la máquina virtual, ya que tiene que realizar modificaciones directamente sobre él):</p><pre><code class=language-bash>sudo virt-sysprep --connect qemu:///system --domain centos6x32-clone
</code></pre><p>El comando anterior lanzará una serie de modificaciónes <em>estándar</em>; estas modificaciones se pueden personalizar con los parámetros <code>--enable</code> y <code>--operations</code>; es posible ver la lista de operaciones posibles con el parámetro <code>--list-operations</code>, y ver lo que se haría sobre la máquina sin realmente hacerlo con el parámetro <code>--dry-run</code>.</p><p>NOTA: La versión de Ubuntu que utilizo es la 13.10, que tiene una versión bastante antigua del comando <code>virt-sysprep</code>, y no reconoce varias de las opciones anteriores, y tiene
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1111662" target=_blank rel=noopener>este bug</a>; para solventarlo, lo que hago es pasarle manualmente la lista de operaciones a realizar:</p><pre><code class=language-bash>sudo virt-sysprep --connect qemu:///system -d centos6x32-clone --enable bash-history,logfiles,hostname,machine-id,net-hwaddr,ssh-hostkeys,ssh-userdir
</code></pre><p>Hay una herramienta adicional (<code>virt-customize</code>) que permite realizar modificaciones sobre el sistema operativo (al estilo de
<a href=http://www.ansible.com/home target=_blank rel=noopener>Ansible</a>,
<a href=http://puppetlabs.com/ target=_blank rel=noopener>Puppet</a>,
<a href=http://www.saltstack.com/ target=_blank rel=noopener>Salt</a>,
<a href=http://www.getchef.com/chef/ target=_blank rel=noopener>Chef</a>, etc. pero más básico), pudiendo establecer la contraseña de root y de usuarios, instalar paquetes, actualizar el sistema, establecer el nombre de host, etc. Lamentablemente, esta aplicación sólo está disponible a partir de la versión 1.26 de
<a href=http://libguestfs.org/ target=_blank rel=noopener>libguestfs</a>, que es bastante posterior a la que hay en Ubuntu. Simplemente, a modo de referencia, el comando funcionaría de la siguiente forma:</p><pre><code class=language-bash>sudo virt-customize --connect qemu:///system -d centos6x32-clone --hostname nuevonombre.pruebas.test
</code></pre><p>Referencias:</p><ul><li><a href=http://libguestfs.org/virt-customize.1.html target=_blank rel=noopener>man virt-customize</a></li><li><a href=http://libguestfs.org/virt-sysprep.1.html target=_blank rel=noopener>man virt-sysprep</a></li><li><a href=https://rwmj.wordpress.com/tag/virt-sysprep/ target=_blank rel=noopener>Richard WM Jones: virt-sysprep</a></li></ul></div><div class=share-box aria-hidden=true><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/&text=Gu%c3%ada%20r%c3%a1pida%20de%20KVM" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/&t=Gu%c3%ada%20r%c3%a1pida%20de%20KVM" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Gu%c3%ada%20r%c3%a1pida%20de%20KVM&body=https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/&title=Gu%c3%ada%20r%c3%a1pida%20de%20KVM" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="https://web.whatsapp.com/send?text=Gu%c3%ada%20r%c3%a1pida%20de%20KVM%20https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/" target=_blank rel=noopener class=share-btn-whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https://blog.okelet.com/posts/2014/08/guia-rapida-de-kvm/&title=Gu%c3%ada%20r%c3%a1pida%20de%20KVM" target=_blank rel=noopener class=share-btn-weibo><i class="fab fa-weibo"></i></a></li></ul></div><section id=comments><div id=disqus_thread></div><script>let disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='https://'+"okeletgithubio"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js integrity="sha256-1zu+3BnLYV9LdiY85uXMzii3bdrkelyp37e0ZyTAQh0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=true;</script><script>const isSiteThemeDark=false;</script><script>const search_config={"indexURI":"/index.json","minLength":1,"threshold":0.3};const i18n={"no_results":"No se encontraron resultados","placeholder":"Buscar...","results":"resultados encontrados"};const content_type={'post':"Posts",'project':"Proyectos",'publication':"Publicaciones",'talk':"Charlas"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script id=dsq-count-scr src=https://okeletgithubio.disqus.com/count.js async></script><script src=/js/academic.min.a07fb7ff02bd7120efbadd0dda2cba9f.js></script><div class=container><footer class=site-footer><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Citar</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copiar</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Descargar</a><div id=modal-error></div></div></div></div></div></body></html>