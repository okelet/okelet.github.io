<!doctype html><html lang=es><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Guía rápida de KVM - Mis notas</title><meta name=renderer content=webkit><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content=no-transform><meta http-equiv=cache-control content=no-siteapp><meta name=theme-color content=#f8f5ec><meta name=msapplication-navbutton-color content=#f8f5ec><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=#f8f5ec><meta name=author content="Juan Asensio"><meta name=description content="De la Wikipedia:
 Kernel-based Virtual Machine o KVM, (en español, Máquina virtual basada en el núcleo) es una solución para implementar virtualización completa con Linux. Está formada por un módulo del núcleo (con el nombre kvm.ko) y herramientas en el espacio de usuario, siendo en su totalidad software libre. El componente KVM para el núcleo está incluido en Linux desde la versión 2.6.20.
KVM permite ejecutar máquinas virtuales utilizando imágenes de disco que contienen sistemas operativos sin modificar. Cada máquina virtual tiene su propio hardware virtualizado: una tarjeta de red, discos duros, tarjeta gráfica, etc.
 En primer lugar, debemos comprobar si nuestro equipo es compatible con KVM:
1  egrep --color &amp;#39;(svm|vmx)&amp;#39; /proc/cpuinfo   Si la salida anterior muestra algo, podremos seguir adelante. Si no muestra nada, también podremos seguir, pero no se aprovecharán las capacidades de virtualización del equipo (se hará un fallback a emulación en lugar de virtualización)."><meta name=keywords content=okelet,linux,bash,python,aws,google,cloud,gcloud><meta name=generator content="Hugo 0.54.0 with even 4.0.0"><link rel=canonical href=https://okelet.netlify.com/posts/2014/08/guia-rapida-de-kvm/><link href=https://okelet.netlify.com/atom.xml type=application/atom+xml rel=alternate title="Mis notas - Atom"><link href=https://okelet.netlify.com/index.xml type=application/rss+xml rel=alternate title="Mis notas - RSS"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/dist/even.c2a46f00.min.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous><link rel=stylesheet href=https://okelet.netlify.com/css/custom.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.9.0/css/all.css><meta property=og:title content="Guía rápida de KVM"><meta property=og:description content="De la Wikipedia:


Kernel-based Virtual Machine o KVM, (en español, Máquina virtual basada en el núcleo) es una solución para implementar virtualización completa con Linux. Está formada por un módulo del núcleo (con el nombre kvm.ko) y herramientas en el espacio de usuario, siendo en su totalidad software libre. El componente KVM para el núcleo está incluido en Linux desde la versión 2.6.20.

KVM permite ejecutar máquinas virtuales utilizando imágenes de disco que contienen sistemas operativos sin modificar. Cada máquina virtual tiene su propio hardware virtualizado: una tarjeta de red, discos duros, tarjeta gráfica, etc.


En primer lugar, debemos comprobar si nuestro equipo es compatible con KVM:


1


egrep --color '(svm|vmx)' /proc/cpuinfo


Si la salida anterior muestra algo, podremos seguir adelante. Si no muestra nada, también podremos seguir, pero no se aprovecharán las capacidades de virtualización del equipo (se hará un fallback a emulación en lugar de virtualización)."><meta property=og:type content=article><meta property=og:url content=https://okelet.netlify.com/posts/2014/08/guia-rapida-de-kvm/><meta property=article:published_time content=2014-08-12T13:12:48&#43;02:00><meta property=article:modified_time content=2014-08-12T13:12:48&#43;02:00><meta itemprop=name content="Guía rápida de KVM"><meta itemprop=description content="De la Wikipedia:


Kernel-based Virtual Machine o KVM, (en español, Máquina virtual basada en el núcleo) es una solución para implementar virtualización completa con Linux. Está formada por un módulo del núcleo (con el nombre kvm.ko) y herramientas en el espacio de usuario, siendo en su totalidad software libre. El componente KVM para el núcleo está incluido en Linux desde la versión 2.6.20.

KVM permite ejecutar máquinas virtuales utilizando imágenes de disco que contienen sistemas operativos sin modificar. Cada máquina virtual tiene su propio hardware virtualizado: una tarjeta de red, discos duros, tarjeta gráfica, etc.


En primer lugar, debemos comprobar si nuestro equipo es compatible con KVM:


1


egrep --color '(svm|vmx)' /proc/cpuinfo


Si la salida anterior muestra algo, podremos seguir adelante. Si no muestra nada, también podremos seguir, pero no se aprovecharán las capacidades de virtualización del equipo (se hará un fallback a emulación en lugar de virtualización)."><meta itemprop=datePublished content=2014-08-12T13:12:48&#43;02:00><meta itemprop=dateModified content=2014-08-12T13:12:48&#43;02:00><meta itemprop=wordCount content=2512><meta itemprop=keywords content><meta name=twitter:card content=summary><meta name=twitter:title content="Guía rápida de KVM"><meta name=twitter:description content="De la Wikipedia:


Kernel-based Virtual Machine o KVM, (en español, Máquina virtual basada en el núcleo) es una solución para implementar virtualización completa con Linux. Está formada por un módulo del núcleo (con el nombre kvm.ko) y herramientas en el espacio de usuario, siendo en su totalidad software libre. El componente KVM para el núcleo está incluido en Linux desde la versión 2.6.20.

KVM permite ejecutar máquinas virtuales utilizando imágenes de disco que contienen sistemas operativos sin modificar. Cada máquina virtual tiene su propio hardware virtualizado: una tarjeta de red, discos duros, tarjeta gráfica, etc.


En primer lugar, debemos comprobar si nuestro equipo es compatible con KVM:


1


egrep --color '(svm|vmx)' /proc/cpuinfo


Si la salida anterior muestra algo, podremos seguir adelante. Si no muestra nada, también podremos seguir, pero no se aprovecharán las capacidades de virtualización del equipo (se hará un fallback a emulación en lugar de virtualización)."><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--><link rel=stylesheet type=text/css href=https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css><script src=https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js></script><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#000"},"button":{"background":"#f1d600"}},"theme":"classic"})});</script></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>Mis notas</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Inicio</li></a><a href=/posts/><li class=mobile-menu-item>Archivos</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/pages/projects/><li class=mobile-menu-item>Proyectos</li></a><a href=/pages/about/><li class=mobile-menu-item>Acerca de</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo>Mis notas</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Inicio</a></li><li class=menu-item><a class=menu-item-link href=/posts/>Archivos</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/pages/projects/>Proyectos</a></li><li class=menu-item><a class=menu-item-link href=/pages/about/>Acerca de</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>Guía rápida de KVM</h1><div class=post-meta><span class=post-time>2014-08-12</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contenidos</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><ul><li><a href=#instalación-en-debian-ubuntu>Instalación en Debian/Ubuntu</a></li><li><a href=#instalación-en-red-hat-centos>Instalación en Red Hat/CentOS</a></li><li><a href=#herramientas-principales-de-gestión>Herramientas principales de gestión</a></li><li><a href=#tipos-de-conexión>Tipos de conexión</a></li><li><a href=#instalación-de-virt-manager-actualizado>Instalación de virt-manager actualizado</a></li><li><a href=#comandos-útiles>Comandos útiles</a></li><li><a href=#creación-rápida-de-máquinas-comunes>Creación rápida de máquinas comunes</a></li><li><a href=#cambiar-cirrus-vnc-por-qxl-spice>Cambiar Cirrus/VNC por QXL/Spice</a></li><li><a href=#intercambiar-entre-kvm-y-virtualbox>Intercambiar entre KVM y VirtualBox</a></li><li><a href=#snapshots>Snapshots</a></li><li><a href=#convertir-imágenes-de-disco-a-qcow2>Convertir imágenes de disco a QCOW2</a></li><li><a href=#clonar-máquinas-virtuales>Clonar máquinas virtuales</a></li></ul></li></ul></nav></div></div><div class=post-outdated><div class=warn><p>[NOTA] Actualizado <span class=timeago datetime=2014-08-12T13:12:48 title="August 12, 2014">August 12, 2014</span>. Este artículo puede contener contenido desactualizado.</p></div></div><div class=post-content><p>De la <a href=http://es.wikipedia.org/wiki/Kernel-based_Virtual_Machine>Wikipedia</a>:</p><blockquote><p>Kernel-based Virtual Machine o KVM, (en español, Máquina virtual basada en el núcleo) es una solución para implementar virtualización completa con Linux. Está formada por un módulo del núcleo (con el nombre kvm.ko) y herramientas en el espacio de usuario, siendo en su totalidad software libre. El componente KVM para el núcleo está incluido en Linux desde la versión 2.6.20.</p><p>KVM permite ejecutar máquinas virtuales utilizando imágenes de disco que contienen sistemas operativos sin modificar. Cada máquina virtual tiene su propio hardware virtualizado: una tarjeta de red, discos duros, tarjeta gráfica, etc.</p></blockquote><p>En primer lugar, debemos comprobar si nuestro equipo es compatible con KVM:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>egrep --color <span class=s1>&#39;(svm|vmx)&#39;</span> /proc/cpuinfo</code></pre></td></tr></table></div></div><p>Si la salida anterior muestra algo, podremos seguir adelante. Si no muestra nada, también podremos seguir, pero no se aprovecharán las capacidades de virtualización del equipo (se hará un <a href=http://blog.vmsplice.net/2011/03/should-i-use-qemu-or-kvm.html><em>fallback</em></a> a emulación en lugar de virtualización).</p><h2 id=instalación-en-debian-ubuntu>Instalación en Debian/Ubuntu</h2><p>Para Debian/Ubuntu, deberemos instalar los siguientes paquetes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo apt-get install cpu-checker qemu-kvm libvirt-bin bridge-utils virt-manager virt-viewer libguestfs-tools</code></pre></td></tr></table></div></div><p>También tendremos que añadir nuestro usuario al grupo <code>libvirtd</code> para poder gestionar máquinas virtuales en el sistema con nuestro propio usuario (sin ser root):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo adduser <span class=si>${</span><span class=nv>USER</span><span class=si>}</span> libvirtd</code></pre></td></tr></table></div></div><p>Por último, deberemos reiniciar la sesión para que se recarguen nuestros permisos de usuario.</p><h2 id=instalación-en-red-hat-centos>Instalación en Red Hat/CentOS</h2><p>Para Red Hat/CentOS, deberemos instalar los siguientes paquetes:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo yum install kvm libvirt virt-viewer virt-manager virt-sysprep</code></pre></td></tr></table></div></div><p>Para poder gestionar máquinas virtuales sin necesidad de ser root, deberemos crear un grupo, agregar nuestro usuario a ese grupo, y configurar ese grupo en KVM para permitirle la gestión (básicamente, estamos simulando el comportamiento que Ubuntu ya hace por sí solo, <a href=http://n40lab.wordpress.com/2012/10/03/installing-kvm-with-yum-and-compiling-libvirt-and-virtmanager/>referencia 1</a> y <a href=http://www.opennet.ru/openforum/vsluhforumID1/93974.html>referencia 2</a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo groupadd libvirtd
sudo usermod -a -G libvirtd <span class=si>${</span><span class=nv>USER</span><span class=si>}</span>
sudo sed -r -i -e <span class=s1>&#39;s/^#?unix_sock_group = .*/unix_sock_group = &#34;libvirtd&#34;/&#39;</span> <span class=se>\
</span><span class=se></span>               -e <span class=s1>&#39;s/^#?unix_sock_rw_perms = .*/unix_sock_rw_perms = &#34;0770&#34;/&#39;</span> <span class=se>\
</span><span class=se></span>               -e <span class=s1>&#39;s/^#?auth_unix_rw = .*/auth_unix_rw = &#34;none&#34;/&#39;</span> <span class=se>\
</span><span class=se></span>               /etc/libvirt/libvirtd.conf
sudo service libvirtd restart</code></pre></td></tr></table></div></div><p>Por último, deberemos reiniciar la sesión para que se recarguen nuestros permisos de usuario.</p><h2 id=herramientas-principales-de-gestión>Herramientas principales de gestión</h2><p>Con KVM disponemos de varias herramientas para gestionar tanto el sistema como las propias máquinas virtuales:</p><ul><li><code>virsh</code>: nos permite gestionar el sistema y las máquinas virtuales a un nivel medio-bajo.</li><li><code>virt-install</code>: nos permite crear máquinas virtuales de una forma sencilla.</li></ul><h2 id=tipos-de-conexión>Tipos de conexión</h2><p>En la instalación por defecto, tenemos dos tipos de conexión:</p><ul><li><code>qemu:///system</code>: nos conectamos al servicio de virtualización del sistema. Las máquinas creadas aquí se pueden configurar para que arranquen automáticamente cuando se inicie el host.</li><li><code>quemu:///session</code>: nos conectamos a nuestra propia sesión. Estas máquinas sólo las podrá ver y gestionar el propio usuario, y además, los archivos de imagen (discos duros, etc.), deberán estar en una ubicación donde el usuario pueda leer y escribir (en la ruta por efecto <code>/var/lib/libvirt/images</code> sólo puede escribir cuando nos conectamos a la URL de sistema).</li></ul><p>Según las pruebas que he hecho, los comandos <code>virsh</code> y <code>virt-instal</code> (explicados en la siguiente sección) se comportan de manera distinta a la hora de conectarse. <code>virsh</code> por defecto se conecta a <code>quemu:///system</code>, mientras que <code>virt-install</code> se conecta a <code>quemu:///session</code>. Por esto, en los siguientes ejemplos, se especifica siempre como URL de conexión <code>quemu:///system</code>, ya que las imágenes de disco se van a crear en <code>/var/lib/libvirt/images</code>. Si no especificásemos URL de conexión, o pusiéramos la de sesión del usuario, deberíamos establecer una ruta de imagen de disco donde el propio usuario pueda escribir, como <code>${HOME}</code>.</p><h2 id=instalación-de-virt-manager-actualizado>Instalación de virt-manager actualizado</h2><p>Uso Ubuntu 13.10 y la versión en los repositorios es la 0.9.5. La última versión de <code>virt-manager</code> es la 1.0.1, pero no está en los repositorios para esta versión de Ubuntu (aunque sí a partir de la 14.04); esta última versión tiene bastantes mejoras, entre ellas, la <a href=http://virt-manager.org/download/>gestión de snapshots</a>. Para instalar la nueva versión no hay más que descargarse el fuente (está escrita en Python); no hay que compilar ni instalar como root (se pueden tener las 2 versiones de <code>virt-manager</code>, la de los repositorios y la instalada a mano, pero hay que tener cuidado con cuál ejecutamos para no volverse uno loco).</p><p>En primer lugar, tenemos que descargar una serie de dependencias adicionales que necesitamos (referencias <a href=http://www.gravitycomputing.co.nz/virt-manager-1-01-debian/>uno</a> y <a href=http://askubuntu.com/questions/340937/virtmanager-0-95-or-0-10-on-ubuntu-and-cannot-import-name-gtkvnc>dos</a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo apt-get install gir1.2-spice-client-gtk-3.0 python-gtk-vnc libglib2.0-bin python-ipaddr libvirt-glib-1.0-dev gir1.2-gtk-vnc-2.0</code></pre></td></tr></table></div></div><p>En principio esto también valdría para Red Hat/CentOS, pero no he encontrado el paquete necesario para la dependencia <code>gi.repository</code> en CentOS 6, y no he podido hacerlo funcionar.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>yum install python-argparse ...</code></pre></td></tr></table></div></div><p>Después de instalar las dependencias, nos bajamos el paquete fuente, lo descomprimimos y lo ejecutamos:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget http://virt-manager.org/download/sources/virt-manager/virt-manager-1.0.1.tar.gz -O - <span class=p>|</span> tar -xz
<span class=nb>cd</span> virt-manager-1.0.1
./virt-manager</code></pre></td></tr></table></div></div><h2 id=comandos-útiles>Comandos útiles</h2><p>Mostrar la lista de máquinas en ejecución en el sistema:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh -c qemu:///system list</code></pre></td></tr></table></div></div><p>Mostrar todas las máquinas configuradas en el sistema:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh -c qemu:///system list --all</code></pre></td></tr></table></div></div><p>En los comandos anteriores, podemos sustituir <code>qemu:///system</code> por <code>quemu:///session</code> para ver las máquinas asociadas a nuestro usuario (ver apartado anterior).</p><p>Mostrar lista de tipos de sistemas operativos; esto es necesario saberlo para cuando vayamos a instalar una máquina con <code>virt-install</code>, ya que deberemos especificar el tipo en el momento de la creación:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virt-install --os-variant list</code></pre></td></tr></table></div></div><p>Parar <em>a lo bruto</em> una máquina:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh destroy nombre_maquina</code></pre></td></tr></table></div></div><p>Eliminar una máquina y todos sus ficheros asociados (snapshots, ficheros de disco, etc.):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh undefine --managed-save --snapshots-metadata --remove-all-storage nombre_maquina</code></pre></td></tr></table></div></div><h2 id=creación-rápida-de-máquinas-comunes>Creación rápida de máquinas comunes</h2><p>CentOS 5 32 bits:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virt-install --connect qemu:///system -n centos5x32 -r <span class=m>512</span> --vcpus<span class=o>=</span><span class=m>1</span> --os-variant<span class=o>=</span>rhel5.4 <span class=se>\
</span><span class=se></span>--graphics spice --disk <span class=nv>path</span><span class=o>=</span>/var/lib/libvirt/images/centos5x32.qcow2,format<span class=o>=</span>qcow2,size<span class=o>=</span><span class=m>8</span> <span class=se>\
</span><span class=se></span>-l http://sunsite.rediris.es/mirror/CentOS/5/os/i386 <span class=se>\
</span><span class=se></span>-x <span class=s2>&#34;lang=es_ES keyboard=es&#34;</span></code></pre></td></tr></table></div></div><p>CentOS 5 64 bits:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virt-install --connect qemu:///system -n centos5x64 -r <span class=m>512</span> --vcpus<span class=o>=</span><span class=m>1</span> --os-variant<span class=o>=</span>rhel5.4 <span class=se>\
</span><span class=se></span>--graphics spice --disk <span class=nv>path</span><span class=o>=</span>/var/lib/libvirt/images/centos5x64.qcow2,format<span class=o>=</span>qcow2,size<span class=o>=</span><span class=m>8</span> <span class=se>\
</span><span class=se></span>-l http://sunsite.rediris.es/mirror/CentOS/5/os/x86_64 <span class=se>\
</span><span class=se></span>-x <span class=s2>&#34;lang=es_ES keyboard=es&#34;</span></code></pre></td></tr></table></div></div><p>CentOS 6 32 bits:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virt-install --connect qemu:///system -n centos6x32 -r <span class=m>1024</span> --vcpus<span class=o>=</span><span class=m>1</span> --os-variant<span class=o>=</span>rhel6 <span class=se>\
</span><span class=se></span>--graphics spice --disk <span class=nv>path</span><span class=o>=</span>/var/lib/libvirt/images/centos6x32.qcow2,format<span class=o>=</span>qcow2,size<span class=o>=</span><span class=m>8</span> <span class=se>\
</span><span class=se></span>-l http://sunsite.rediris.es/mirror/CentOS/6/os/i386 <span class=se>\
</span><span class=se></span>-x <span class=s2>&#34;lang=es_ES keyboard=es&#34;</span></code></pre></td></tr></table></div></div><p>CentOS 6 64 bits:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virt-install --connect qemu:///system -n centos6x64 -r <span class=m>1024</span> --vcpus<span class=o>=</span><span class=m>1</span> --os-variant<span class=o>=</span>rhel6 <span class=se>\
</span><span class=se></span>--graphics spice --disk <span class=nv>path</span><span class=o>=</span>/var/lib/libvirt/images/centos6x64.qcow2,format<span class=o>=</span>qcow2,size<span class=o>=</span><span class=m>8</span> <span class=se>\
</span><span class=se></span>-l http://sunsite.rediris.es/mirror/CentOS/6/os/x86_64 <span class=se>\
</span><span class=se></span>-x <span class=s2>&#34;lang=es_ES keyboard=es&#34;</span></code></pre></td></tr></table></div></div><p>CentOS 7 64 bits (<a href=https://access.redhat.com/solutions/509373>no existe versión de 32 bits</a>):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virt-install --connect qemu:///system -n centos7x64 -r <span class=m>1024</span> --vcpus<span class=o>=</span><span class=m>1</span> --os-variant<span class=o>=</span>rhel7 <span class=se>\
</span><span class=se></span>--graphics spice --disk <span class=nv>path</span><span class=o>=</span>/var/lib/libvirt/images/centos7x64.qcow2,format<span class=o>=</span>qcow2,size<span class=o>=</span><span class=m>8</span> <span class=se>\
</span><span class=se></span>-l http://sunsite.rediris.es/mirror/CentOS/7/os/x86_64 <span class=se>\
</span><span class=se></span>-x <span class=s2>&#34;lang=es_ES keyboard=es&#34;</span></code></pre></td></tr></table></div></div><p>Debian 7 32 bits:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virt-install --connect qemu:///system -n debian7x32 -r <span class=m>512</span> --vcpus <span class=m>1</span> --os-variant debianwheezy <span class=se>\
</span><span class=se></span>--graphics spice --disk <span class=nv>path</span><span class=o>=</span>/var/lib/libvirt/images/debian7x32.qcow2,format<span class=o>=</span>qcow2,size<span class=o>=</span><span class=m>8</span> <span class=se>\
</span><span class=se></span>-l http://ftp.debian.org/debian/dists/wheezy/main/installer-i386/ <span class=se>\
</span><span class=se></span>-x <span class=s2>&#34;language=es country=ES debian-installer/locale=es_ES.UTF-8 keyboard-configuration/xkb-keymap=es\
</span><span class=s2>    time/zone=Europe/Madrid passwd/make-user=false&#34;</span></code></pre></td></tr></table></div></div><p>Debian 7 64 bits:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virt-install --connect qemu:///system -n debian7x64 -r <span class=m>512</span> --vcpus <span class=m>1</span> --os-variant debianwheezy <span class=se>\
</span><span class=se></span>--graphics spice --disk <span class=nv>path</span><span class=o>=</span>/var/lib/libvirt/images/debian7x64.qcow2,format<span class=o>=</span>qcow2,size<span class=o>=</span><span class=m>8</span> <span class=se>\
</span><span class=se></span>-l http://ftp.debian.org/debian/dists/wheezy/main/installer-amd64/ <span class=se>\
</span><span class=se></span>-x <span class=s2>&#34;language=es country=ES debian-installer/locale=es_ES.UTF-8 keyboard-configuration/xkb-keymap=es \
</span><span class=s2>    time/zone=Europe/Madrid passwd/make-user=false&#34;</span></code></pre></td></tr></table></div></div><p>Los comandos anteriores tienen el parámetro <code>-x</code> (<code>--extra-args</code>). Estos parámetros se pasan automáticamente al kernel de arranque de instalación del sistema operativo. Con ellos, podemos configurar automáticamente ciertos parámetros que se nos pide durante la instalación (los más usados en los ejemplos anteriores sirven para configurar el idioma, la localización, la distribución del teclado, la zona horaria, o incluso si crear o no un usuario regular en el sistema). También es posible pasar una ruta a un fichero KickStart (Red Hat/CentOS) o Preseed (Debian/Ubuntu) para automatizar completamente la instalación. Más información:</p><ul><li>Red Hat/CentOS: parámetros de arranque <a href=https://www.centos.org/docs/5/html/Installation_Guide-en-US/ch-bootopts-x86.html>uno</a> y <a href=https://www.centos.org/docs/5/html/installation_Guide-en-US/s1-kickstart2-options.html>dos</a>, <a href=http://fedoraproject.org/wiki/Anaconda/Kickstart>Kickstart</a></li><li>Debian/Ubuntu: <a href=https://www.debian.org/releases/stable/i386/ch05s03.html.en>parámetros de arranque</a>, <a href=https://wiki.debian.org/DebianInstaller/>Preseed</a></li></ul><p>Para especificar un proxy de instalación en los casos anteriores, se deben especificar las siguientes opciones:</p><ul><li>Para Debian/Ubuntu: <code>mirror/http/proxy=http://[usuario:contraseña@]proxy.dominio.com:3128/</code></li><li>Para CentOS/Red Hat: <code>proxy=http://[usuario:contraseña@]proxy.dominio.com:3128/</code></li></ul><p>La opción <code>--graphics spice</code> especificada en los comandos anteriores permite una mejor calidad y mayor rendimiento de los gráficos en la máquina virtual, usando el driver <code>qxl</code>, así como una mejor integración con el host a través del protocolo <a href=http://spice-space.org>Spice</a>, permitiendo el cambio de resolución de la máquina virtual según redimensionemos el visor, redirección del sonido, copiar y pegar, etc. En caso de que no se especifique esta opción se usaría una comunicación mediante VNC y un driver Cirrus. Para que el protocolo Spice funcion correctamente en la máquina virtual, deberemos asegurarnos que está instalado el driver gráfico adecuado y el agente de Spice, según lo indicado en el siguiente apartado.</p><h2 id=cambiar-cirrus-vnc-por-qxl-spice>Cambiar Cirrus/VNC por QXL/Spice</h2><p>Como he comentando antes, el protocolo Spice ofrece un rendimiento mayor y mejor integración con el huésped. Si tenemos alguna máquina virtual creada con las opciones por defecto, podemos actualizarla cambiando las opciones adecuadas. Para ello, con la máquina virtual parada, editaremos su configuración XML y mofificaremos los bloques especificados a continuación:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh edit nombre_maquina</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml>    <span class=nt>&lt;channel</span> <span class=na>type=</span><span class=s>&#39;spicevmc&#39;</span><span class=nt>&gt;</span>
      <span class=nt>&lt;target</span> <span class=na>type=</span><span class=s>&#39;virtio&#39;</span> <span class=na>name=</span><span class=s>&#39;com.redhat.spice.0&#39;</span><span class=nt>/&gt;</span>
      <span class=nt>&lt;address</span> <span class=na>type=</span><span class=s>&#39;virtio-serial&#39;</span> <span class=na>controller=</span><span class=s>&#39;0&#39;</span> <span class=na>bus=</span><span class=s>&#39;0&#39;</span> <span class=na>port=</span><span class=s>&#39;1&#39;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;/channel&gt;</span>
    <span class=nt>&lt;graphics</span> <span class=na>type=</span><span class=s>&#39;spice&#39;</span> <span class=na>autoport=</span><span class=s>&#39;yes&#39;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;video&gt;</span>
      <span class=nt>&lt;model</span> <span class=na>type=</span><span class=s>&#39;qxl&#39;</span> <span class=na>ram=</span><span class=s>&#39;65536&#39;</span> <span class=na>vram=</span><span class=s>&#39;65536&#39;</span> <span class=na>heads=</span><span class=s>&#39;1&#39;</span><span class=nt>/&gt;</span>
      <span class=nt>&lt;address</span> <span class=na>type=</span><span class=s>&#39;pci&#39;</span> <span class=na>domain=</span><span class=s>&#39;0x0000&#39;</span> <span class=na>bus=</span><span class=s>&#39;0x00&#39;</span> <span class=na>slot=</span><span class=s>&#39;0x02&#39;</span> <span class=na>function=</span><span class=s>&#39;0x0&#39;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;/video&gt;</span></code></pre></td></tr></table></div></div><p>Tras esto, ya podemos arrancar la máquina virtual y debemos asegurarnos de tener instalado tanto el driver gráfico correspondiente, como el agente de Spice. Para ello, ejecutaremos los siguientes comandos en distribuciones Debian/Ubuntu:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo apt-get install xserver-xorg-video-qxl spice-vdagent
sudo update-rc.d spice-vdagent defaults
sudo service spice-vdagent start</code></pre></td></tr></table></div></div><p>Estos otros en distribuciones Red Hat/CentOS con SysV (versiones 6 y anteriores):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo yum install xorg-x11-drv-qxl spice-vdagent
sudo chkconfig spice-vdagentd on
sudo service spice-vdagentd start</code></pre></td></tr></table></div></div><p>Y estos otros en distribuciones Red Hat/CentOS con Systemd (versiones 7 y posteriores):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo yum install xorg-x11-drv-qxl spice-vdagent
sudo systemctl <span class=nb>enable</span> spice-vdagentd
sudo systemctl start spice-vdagentd</code></pre></td></tr></table></div></div><p>Para finalizar, deberemos reiniciar la máquina virtual para que se apliquen los cambios.</p><h2 id=intercambiar-entre-kvm-y-virtualbox>Intercambiar entre KVM y VirtualBox</h2><p>Si se tiene instalado VirtualBox, KVM no se ejecutará con todas las características de virtualización completas, sino que delegará en QEMU (que es mucho más lento), o bien VirtualBox no se ejecutará diciendo que no se han podido cargar sus módulos (<a href=http://www.dedoimedo.com/computers/kvm-virtualbox.html>dependiendo del orden de carga de los módulos de KVM o VirtualBox, será uno u otro el que no funcione</a>). Para solventar esto, o bien debemos desinstalar uno de los dos sistemas, o bien debemos desactivar los módulos del otro cuando vayamos a ejecutar un sistema de virtualización.</p><p>Para usar KVM:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo /etc/init.d/vboxdrv stop
sudo modprobe kvm
sudo modprobe kvm_intel</code></pre></td></tr></table></div></div><p>Para usar VirtualBox:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo modprobe -r kvm_intel
sudo modprobe -r kvm
sudo /etc/init.d/vboxdrv start</code></pre></td></tr></table></div></div><p>En mi caso, que tengo en el trabajo un Dell OptiPlex 755, hay que tocar algunas cosas en la BIOS para que funcione correctamente KVM, ya que cuando intentaba cargar el módulo <code>kvm_intel</code> me daba un error de <code>Operation not supported</code>. En esta <a href=http://serverfault.com/questions/534934/vt-enabled-in-bios-but-kvm-failed-to-detect>pregunta de serverfault</a>, que a su vez <a href=http://reidablog.blogspot.com.es/2008/06/with-correct-bios-settings-enabled-on.html>hace referencia a ésta</a>, indican las opciones de la BIOS que se deben poner para que funcione; en resumen:</p><ul><li>Security: Execute Disable should be On</li><li>Performance: Virtualization should be On</li><li>Performance: VT for Direct I/O Access should be On</li><li>Performance: Trusted Execution should be Off</li></ul><h2 id=snapshots>Snapshots</h2><p>Para poder tomar snapshots, el formato de los discos debe ser alguno que sea compatible; si al crear la máquina, no se especifica uno, se crearán con el formato <code>raw</code>, que no los permite; por eso, en todos los comandos anteriores se usa el formato <code>qcow2</code>.</p><p>Mostrar los snapshots de una máquina:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh snapshot-list nombre_maquina</code></pre></td></tr></table></div></div><p>Tomar un snapshot de una máquina:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh snapshot-create-as nombre_maquina <span class=s2>&#34;Nombre del snapshot (opcional)&#34;</span> <span class=s2>&#34;Descripción del snapshot (opcional)&#34;</span></code></pre></td></tr></table></div></div><p>Revertir a un snapshot anterior:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh snapshot-revert nombre_maquina <span class=o>[</span>nombre_snapshot<span class=p>|</span>--current<span class=o>]</span></code></pre></td></tr></table></div></div><p>Eliminar un snapshot:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh snapshot-delete nombre_maquina <span class=o>[</span>nombre_snapshot<span class=p>|</span>--current<span class=o>]</span> <span class=o>[{</span>--children <span class=p>|</span> --children-only<span class=o>}]</span></code></pre></td></tr></table></div></div><h2 id=convertir-imágenes-de-disco-a-qcow2>Convertir imágenes de disco a QCOW2</h2><p>En caso de que tengamos una máquina virtual con un disco en formato <code>raw</code>, no podremos utilizar la funcionalidad de snapshots, como hemos comentado antes. Para solucionar esto, deberemos convertir el fichero de imagen de la máquina a formato <code>qcow2</code>, y luego editar la configuración de la máquina virtual para decirle que hemos cambiado el formato del disco.</p><p>Para convertir el formato (se debe hacer con la máquina apagada, y con <code>sudo</code> ya que necesita acceder directamente al disco para leerlo y luego poder crear el nuevo):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo qemu-img convert -f raw -O qcow2 /var/lib/libvirt/images/centos7x64.<span class=o>{</span>img,qcow2<span class=o>}</span></code></pre></td></tr></table></div></div><p>Tras esto, debemos reconfigurar la máquina virtual para indicar el nuevo nombre del fichero y formato del disco (al igual que antes, con la máquina apagada):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virsh edit centos7x64</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml>    <span class=nt>&lt;disk</span> <span class=na>type=</span><span class=s>&#39;file&#39;</span> <span class=na>device=</span><span class=s>&#39;disk&#39;</span><span class=nt>&gt;</span>
      <span class=nt>&lt;driver</span> <span class=na>name=</span><span class=s>&#39;qemu&#39;</span> <span class=na>type=</span><span class=s>&#39;qcow2&#39;</span><span class=nt>/&gt;</span>
      <span class=nt>&lt;source</span> <span class=na>file=</span><span class=s>&#39;/var/lib/libvirt/images/centos7x64.qcow2&#39;</span><span class=nt>/&gt;</span>
      <span class=nt>&lt;target</span> <span class=na>dev=</span><span class=s>&#39;vda&#39;</span> <span class=na>bus=</span><span class=s>&#39;virtio&#39;</span><span class=nt>/&gt;</span>
      <span class=nt>&lt;address</span> <span class=na>type=</span><span class=s>&#39;pci&#39;</span> <span class=na>domain=</span><span class=s>&#39;0x0000&#39;</span> <span class=na>bus=</span><span class=s>&#39;0x00&#39;</span> <span class=na>slot=</span><span class=s>&#39;0x04&#39;</span> <span class=na>function=</span><span class=s>&#39;0x0&#39;</span><span class=nt>/&gt;</span>
    <span class=nt>&lt;/disk&gt;</span></code></pre></td></tr></table></div></div><h2 id=clonar-máquinas-virtuales>Clonar máquinas virtuales</h2><p>A la hora de clonar máquinas virtuales debemos tener en cuenta varias cosas:</p><ul><li>Se debe duplicar el disco</li><li>Se debe generar una nueva dirección MAC para cada una de las tarjetas de red</li><li>A nivel de sistema operativo:<ul><li>Cambiar la dirección MAC con la nueva en los archivos de configuración (<code>/etc/sysconfig/network-scripts/ifcfg-eth*</code> en Red Hat/CentOS)</li><li>Se deben eliminar y regerenerar las claves SSH antiguas</li><li>Se deberían eliminar los usuarios del sistema original</li></ul></li><li>Y cualquier cosa más que se nos ocurra</li></ul><p>Para realizar todas estas tareas, disponemos principalmente de 2 herramientas:</p><ul><li><code>virt-clone</code>: realiza el clonado en sí de la máquina, copiando el disco, y cambiando las direcciones MAC de las tarjetas (a nivel de KVM sólo, no a nivel del sistema operativo virtual).</li><li><code>virt-sysprep</code>: permite realizar modificaciones en el sistema operativo para configurarlo correctamente con las nuevas especificaciones (MAC, SSH, etc.).</li></ul><p>Desde la aplicación <code>virt-manager</code> es bastante sencillo, pues se realiza en apenas 2 clicks por la interfaz gráfica. Para hacerlo por comandos, realizaremos los siguientes pasos. En primer lugar, clonaremos la máquina en sí (si no especificamos manualmente un disco de destino con la opción <code>--file</code>, se nos creará uno automáticamente con el nombre de a nueva máquina; si no especificamos tampoco una MAC manualmente con el parámetro <code>--mac</code>, se generará una aleatoria automáticamente):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>virt-clone --connect qemu:///system --original centos6x32 --auto-clone --name centos6x32-clone</code></pre></td></tr></table></div></div><p>Tras esto, ejecuataremos (<code>virt-sysprep</code> se tiene que ejecutar con <code>sudo</code> o dar permisos de lectura y escritura al usuario actual sobre el archivo de imagen de la máquina virtual, ya que tiene que realizar modificaciones directamente sobre él):</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo virt-sysprep --connect qemu:///system --domain centos6x32-clone</code></pre></td></tr></table></div></div><p>El comando anterior lanzará una serie de modificaciónes <em>estándar</em>; estas modificaciones se pueden personalizar con los parámetros <code>--enable</code> y <code>--operations</code>; es posible ver la lista de operaciones posibles con el parámetro <code>--list-operations</code>, y ver lo que se haría sobre la máquina sin realmente hacerlo con el parámetro <code>--dry-run</code>.</p><p>NOTA: La versión de Ubuntu que utilizo es la 13.10, que tiene una versión bastante antigua del comando <code>virt-sysprep</code>, y no reconoce varias de las opciones anteriores, y tiene <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1111662">este bug</a>; para solventarlo, lo que hago es pasarle manualmente la lista de operaciones a realizar:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo virt-sysprep --connect qemu:///system -d centos6x32-clone --enable bash-history,logfiles,hostname,machine-id,net-hwaddr,ssh-hostkeys,ssh-userdir</code></pre></td></tr></table></div></div><p>Hay una herramienta adicional (<code>virt-customize</code>) que permite realizar modificaciones sobre el sistema operativo (al estilo de <a href=http://www.ansible.com/home>Ansible</a>, <a href=http://puppetlabs.com/>Puppet</a>, <a href=http://www.saltstack.com/>Salt</a>, <a href=http://www.getchef.com/chef/>Chef</a>, etc. pero más básico), pudiendo establecer la contraseña de root y de usuarios, instalar paquetes, actualizar el sistema, establecer el nombre de host, etc. Lamentablemente, esta aplicación sólo está disponible a partir de la versión 1.26 de <a href=http://libguestfs.org/>libguestfs</a>, que es bastante posterior a la que hay en Ubuntu. Simplemente, a modo de referencia, el comando funcionaría de la siguiente forma:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>sudo virt-customize --connect qemu:///system -d centos6x32-clone --hostname nuevonombre.pruebas.test</code></pre></td></tr></table></div></div><p>Referencias:</p><ul><li><a href=http://libguestfs.org/virt-customize.1.html>man virt-customize</a></li><li><a href=http://libguestfs.org/virt-sysprep.1.html>man virt-sysprep</a></li><li><a href=https://rwmj.wordpress.com/tag/virt-sysprep/>Richard WM Jones: virt-sysprep</a></li></ul></div><footer class=post-footer><nav class=post-nav><a class=prev href=/posts/2014/09/compilar-nxlog-en-red-hatcentos-5/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Compilar NXLOG en Red Hat/CentOS 5</span>
<span class="prev-text nav-mobile">Previo</span></a>
<a class=next href=/posts/2014/08/red-nat-privada-con-salida-al-exterior-en-virtualbox/><span class="next-text nav-default">Red NAT privada con salida al exterior en VirtualBox</span>
<span class="next-text nav-mobile">Siguiente</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==='localhost')return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='okeletgithubio';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=https://stackoverflow.com/users/576138/okelet class="iconfont icon-stack-overflow" title=stack-overflow></a><a href=https://www.linkedin.com/in/okelet/ class="iconfont icon-linkedin" title=linkedin></a><a href=https://github.com/okelet/ class="iconfont icon-github" title=github></a><a href=https://gitlab.com/okelet class="iconfont icon-gitlab" title=gitlab></a><a href=https://okelet.netlify.com/atom.xml type=application/atom+xml class="iconfont icon-rss" title="Atom feed"></a></div><div class=copyright><span class=power-by>Creado con <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Tema -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2017 -
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>Juan Asensio</span></span></div><script type=text/javascript>(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym");ym(54019648,"init",{clickmap:true,trackLinks:true,accurateTrackBounce:true});</script><noscript><div><img src=https://mc.yandex.ru/watch/54019648 style=position:absolute;left:-9999px alt></div></noscript></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin=anonymous></script><script>var languageCode="es".replace(/-/g,'_').replace(/_(.*)/,function($0,$1){return $0.replace($1,$1.toUpperCase());});timeago().render(document.querySelectorAll('.timeago'),languageCode);timeago.cancel();</script><script type=text/javascript src=/dist/even.26188efa.min.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-53728915-2','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=/js/custom.js></script></body></html>