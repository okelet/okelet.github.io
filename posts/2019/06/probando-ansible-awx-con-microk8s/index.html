<!doctype html><html lang=es-es><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.7.0"><meta name=author content="Juan Asensio"><meta name=description content="AVISO: Post largo (intro a Ansible, AWX, MicroK8s)
Actualización 2020-01-14: Actualizado a 
Ansible AWX 9.1.1
Ansible (/ánsibol/) es el gestor de configuración de moda, y por méritos propios. Aunque no es perfecto (en determinadas ocasiones se puede preferir un modelo cliente/servidor en lugar de una conexión SSH ad-hoc), ofrece una buena combinación entre funcionalidad y simplicidad. Siempre y cuando tengamos conectividad SSH con la máquina a gestionar (o no, a través de 
bastiones), en el caso de equipos Linux, o conectividad WinRM o o PSRP para equipos Windows, podremos realizar infinidad de acciones o tareas sobre las máquinas a gestionar.
Uno de los problemas de Ansible (hablando correctamente, 
Ansible Engine) es que no tiene una forma de ejecutar de forma automatizada playbooks, para mantener la configuración sincronizada de forma periódica, ejecutar tareas planificadas o incluso auto-provisionar equipos. Aquí es donde entra Ansible Tower, que es la versión con soporte de 
Ansible AWX, al estilo de lo que Red Hat hace con Wildfly y JBoss. Ansible Tower/AWX en básicamente una API REST con una interfaz web que se comunica con ella. Utilizando esta API, se pueden definir inventarios, credenciales, equipos, plantillas de trabajo, flujos de trabajo, etc. así como asignar permisos por usarios/grupos mediante su sistema RBAC."><link rel=alternate hreflang=es-es href=https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/><meta name=theme-color content="#2962ff"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/styles/dracula.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53728915-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
function trackOutboundLink(url,target){gtag('event','click',{'event_category':'outbound','event_label':url,'transport_type':'beacon','event_callback':function(){if(target!=='_blank'){document.location=url;}}});console.debug("Outbound link clicked: "+url);}
function onClickCallback(event){if((event.target.tagName!=='A')||(event.target.host===window.location.host)){return;}
trackOutboundLink(event.target,event.target.getAttribute('target'));}
gtag('js',new Date());gtag('config','UA-53728915-2',{'anonymize_ip':true});document.addEventListener('click',onClickCallback,false);</script><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png><link rel=canonical href=https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/><meta property="twitter:card" content="summary"><meta property="og:site_name" content="Notas de Cloud y DevOps"><meta property="og:url" content="https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/"><meta property="og:title" content="Probando Ansible AWX con MicroK8s | Notas de Cloud y DevOps"><meta property="og:description" content="AVISO: Post largo (intro a Ansible, AWX, MicroK8s)
Actualización 2020-01-14: Actualizado a 
Ansible AWX 9.1.1
Ansible (/ánsibol/) es el gestor de configuración de moda, y por méritos propios. Aunque no es perfecto (en determinadas ocasiones se puede preferir un modelo cliente/servidor en lugar de una conexión SSH ad-hoc), ofrece una buena combinación entre funcionalidad y simplicidad. Siempre y cuando tengamos conectividad SSH con la máquina a gestionar (o no, a través de 
bastiones), en el caso de equipos Linux, o conectividad WinRM o o PSRP para equipos Windows, podremos realizar infinidad de acciones o tareas sobre las máquinas a gestionar.
Uno de los problemas de Ansible (hablando correctamente, 
Ansible Engine) es que no tiene una forma de ejecutar de forma automatizada playbooks, para mantener la configuración sincronizada de forma periódica, ejecutar tareas planificadas o incluso auto-provisionar equipos. Aquí es donde entra Ansible Tower, que es la versión con soporte de 
Ansible AWX, al estilo de lo que Red Hat hace con Wildfly y JBoss. Ansible Tower/AWX en básicamente una API REST con una interfaz web que se comunica con ella. Utilizando esta API, se pueden definir inventarios, credenciales, equipos, plantillas de trabajo, flujos de trabajo, etc. así como asignar permisos por usarios/grupos mediante su sistema RBAC."><meta property="og:image" content="img/map[gravatar:%!s(bool=false) shape:circle]"><meta property="twitter:image" content="img/map[gravatar:%!s(bool=false) shape:circle]"><meta property="og:locale" content="es-ES"><meta property="article:published_time" content="2019-06-19T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-18T00:00:00+00:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/"},"headline":"Probando Ansible AWX con MicroK8s","datePublished":"2019-06-19T00:00:00Z","dateModified":"2020-01-18T00:00:00Z","author":{"@type":"Person","name":"Juan Asensio"},"publisher":{"@type":"Organization","name":"Notas de Cloud y DevOps","logo":{"@type":"ImageObject","url":"https://blog.okelet.com/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png"}},"description":"\u003cp\u003eAVISO: Post largo (intro a Ansible, AWX, MicroK8s)\u003c/p\u003e\n\u003cp\u003eActualización 2020-01-14: Actualizado a \n\u003ca href=\"https://groups.google.com/forum/#!topic/awx-project/aYYtuAuHMzY\" target=\"_blank\" rel=\"noopener\"\u003eAnsible AWX 9.1.1\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eAnsible (\u003cem\u003e/ánsibol/\u003c/em\u003e) es el gestor de configuración de moda, y por méritos propios. Aunque no es perfecto (en determinadas ocasiones se puede preferir un modelo cliente/servidor en lugar de una conexión SSH \u003cem\u003ead-hoc\u003c/em\u003e), ofrece una buena combinación entre funcionalidad y simplicidad. Siempre y cuando tengamos conectividad SSH con la máquina a gestionar (o no, a través de \n\u003ca href=\"https://docs.aws.amazon.com/es_es/quickstart/latest/linux-bastion/architecture.html\" target=\"_blank\" rel=\"noopener\"\u003ebastiones\u003c/a\u003e), en el caso de equipos Linux, o conectividad WinRM o o PSRP para equipos Windows, podremos realizar infinidad de acciones o tareas sobre las máquinas a gestionar.\u003c/p\u003e\n\u003cp\u003eUno de los problemas de Ansible (hablando correctamente, \n\u003ca href=\"https://www.ansible.com/blog/red-hat-ansible-automation-engine-vs-tower\" target=\"_blank\" rel=\"noopener\"\u003eAnsible Engine\u003c/a\u003e) es que no tiene una forma de ejecutar de forma automatizada playbooks, para mantener la configuración sincronizada de forma periódica, ejecutar tareas planificadas o incluso auto-provisionar equipos. Aquí es donde entra Ansible Tower, que es la versión con soporte de \n\u003ca href=\"https://github.com/ansible/awx\" target=\"_blank\" rel=\"noopener\"\u003eAnsible AWX\u003c/a\u003e, al estilo de lo que Red Hat hace con Wildfly y JBoss. Ansible Tower/AWX en básicamente una API REST con una interfaz web que se comunica con ella. Utilizando esta API, se pueden definir inventarios, credenciales, equipos, plantillas de trabajo, flujos de trabajo, etc. así como asignar permisos por usarios/grupos mediante su sistema RBAC.\u003c/p\u003e"}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#2962ff","text":"#fff"},"button":{"background":"#fff","text":"#2962ff"}},"theme":"classic","content":{"message":"Este sitio web utiliza cookies para garantizarle una mejor experiencia.","dismiss":"¡Entendido!","link":"Más información","href":"https://www.cookiesandyou.com"}})});</script><script src=https://identity.netlify.com/v1/netlify-identity-widget.js></script><title>Probando Ansible AWX con MicroK8s | Notas de Cloud y DevOps</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Buscar</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Buscar... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>Notas de Cloud y DevOps</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Barra de navegación">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>Notas de Cloud y DevOps</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class="nav-link active" href=/><span>Inicio</span></a></li><li class=nav-item><a class=nav-link href=/post/><span>Archivos</span></a></li><li class=nav-item><a class=nav-link href=/tags/><span>Tags</span></a></li><li class=nav-item><a class=nav-link href=/projects/><span>Proyectos</span></a></li><li class=nav-item><a class=nav-link href=/index.xml><span>RSS</span></a></li><li class=nav-item><a class=nav-link href=/authors/okelet/><span>Acerca de</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=#><i class="fas fa-search" aria-hidden=true></i></a></li><li class=nav-item><a class="nav-link js-dark-toggle" href=#><i class="fas fa-moon" aria-hidden=true></i></a></li></ul></div></nav><article class=article><div class="article-container pt-3"><h1>Probando Ansible AWX con MicroK8s</h1><div class=article-metadata><span class=article-date>Última actualización el
Sat, 18 Jan 2020</span>
<span class=middot-divider></span><span class=article-reading-time>7 min de lectura</span>
<span class=middot-divider></span><a href=/posts/2019/06/probando-ansible-awx-con-microk8s/#disqus_thread></a></div></div><div class=article-container><div class=article-style><p>AVISO: Post largo (intro a Ansible, AWX, MicroK8s)</p><p>Actualización 2020-01-14: Actualizado a
<a href=https://groups.google.com/forum/#!topic/awx-project/aYYtuAuHMzY target=_blank rel=noopener>Ansible AWX 9.1.1</a></p><p>Ansible (<em>/ánsibol/</em>) es el gestor de configuración de moda, y por méritos propios. Aunque no es perfecto (en determinadas ocasiones se puede preferir un modelo cliente/servidor en lugar de una conexión SSH <em>ad-hoc</em>), ofrece una buena combinación entre funcionalidad y simplicidad. Siempre y cuando tengamos conectividad SSH con la máquina a gestionar (o no, a través de
<a href=https://docs.aws.amazon.com/es_es/quickstart/latest/linux-bastion/architecture.html target=_blank rel=noopener>bastiones</a>), en el caso de equipos Linux, o conectividad WinRM o o PSRP para equipos Windows, podremos realizar infinidad de acciones o tareas sobre las máquinas a gestionar.</p><p>Uno de los problemas de Ansible (hablando correctamente,
<a href=https://www.ansible.com/blog/red-hat-ansible-automation-engine-vs-tower target=_blank rel=noopener>Ansible Engine</a>) es que no tiene una forma de ejecutar de forma automatizada playbooks, para mantener la configuración sincronizada de forma periódica, ejecutar tareas planificadas o incluso auto-provisionar equipos. Aquí es donde entra Ansible Tower, que es la versión con soporte de
<a href=https://github.com/ansible/awx target=_blank rel=noopener>Ansible AWX</a>, al estilo de lo que Red Hat hace con Wildfly y JBoss. Ansible Tower/AWX en básicamente una API REST con una interfaz web que se comunica con ella. Utilizando esta API, se pueden definir inventarios, credenciales, equipos, plantillas de trabajo, flujos de trabajo, etc. así como asignar permisos por usarios/grupos mediante su sistema RBAC.</p><p>He de reconocer que al principio cuesta un poco, pero cuando se le pilla el truco, uno se da cuenta de lo potente que es. Pero lo que no me explico es la complejidad de instalación del software. Creo que Red Hat se está empeñando en poner las cosas difíciles a quienes usan sus productos sin suscripción (que al final son los que en gran medida depuran el software, contribuyen de forma gratuita, etc.); en este caso, se nos obliga a hacer una instalación mediante Docker, que aunque está de moda, que lo veo muy bien, creo que deberían dar alternativas (que sí que las dan con la versión con soporte, por lo que impedimentos técnicos no los hay, simplemente es intencionalidad). Para la versión libre (AWX) se soportan los siguientes
<a href=https://github.com/ansible/awx/blob/devel/INSTALL.md target=_blank rel=noopener>métodos de instalación</a>:</p><ul><li>Openshift (claramente enfocado a utilizar un stack completo de Red Hat)</li><li>Docker Compose</li><li>Kubernetes</li></ul><p>En cambio, para Tower, la versión con soporte, es básicamente un script de instalación, que la verdad no he probado, aunque me imagino que lo que hace es provisionar los nodos con el software necesario, a la antigua usanza (no sé si por debajo creará un cluster de K8s u Openshift, o directamente lo hace sobre el sistema operativo).</p><p>Básicamente, la forma de instalación de AWX es crear una serie de contenedores en el orquestador en cuestión (AWX task, AWX web, RabbitMQ, Postgres, Memcached).</p><p>Con ideas de probar AWX para un proyecto interno, empecé a analizar las 3 opciones de instalación; la primera de ellas, Openshift, la descarté desde el principio por ser una tecnología no muy extendida, en favor, en todo caso, de Kubernetes. Ya que esto era una
<a href=https://es.wikipedia.org/wiki/Prueba_de_concepto target=_blank rel=noopener>PoC</a>, no quería complicarme mucho con Kubernetes, por lo que empecé a probar con Docker Compose, pero a la hora de escalar, lanzando la instalación en varios nodos, me di cuenta de que el modo de funcionar de AWX requiere un cluster de
<a href=https://www.rabbitmq.com/ target=_blank rel=noopener>RabbitMQ</a>, que es difícil de configurar dinámicamente con Docker Compose. Con Kubernetes y su
<a href=https://github.com/ansible/awx/blob/devel/installer/roles/kubernetes/templates/deployment.yml.j2#L38 target=_blank rel=noopener>&ldquo;magia&rdquo;</a> hace que el cluster de RabbitMQ se configure y escale automáticamente.</p><p>Siendo mi única opción Kubernetes, no quería montarme un cluster por mi cuenta, ni tener que montar un cluster de EKS, que
<a href=https://aws.amazon.com/es/eks/pricing/ target=_blank rel=noopener>de base ya son 144$ al mes</a> más los nodos de computación, al final tuve que buscar alternativas más simples.</p><p>Mi primera intención fue probar
<a href=https://kubernetes.io/es/docs/tasks/tools/install-minikube/ target=_blank rel=noopener>Minikube</a> en mi máquina local, pero cada pod de AWX consume 6 GB de RAM, por lo que mínimo a la MV de Minikube le tenía que dar 7 GB, y teniendo mi portátil 8 GB, murió varias veces en el intento&mldr; Me planteé montar Minikube en una instancia EC2, pero esto sería montar Virtualbox, sobre un entorno ya virtualizado (EC2), y sobre el que correría Kubernetes&mldr; Aunque factible, me parecía un poco engorroso. Así que gracias a mi compañero Roque, que me recordó la existencia de
<a href=https://microk8s.io/ target=_blank rel=noopener>MicroK8s</a>, me decidí a probar.</p><p>Partiendo de una EC2 con Ubuntu 18.04 limpia, estos son los comandos a ejecutar para montar un entorno de Ansible AWX con MicroK8s (forzamos la versión 1.15, ya que AWX no es compatible con una versión mayor, por ahora):</p><pre><code class=language-bash>sudo snap refresh microk8s --channel 1.15/stable
sudo snap install helm --channel=2.16/stable --classic

(grep &quot;^--allow-privileged$&quot; /var/snap/microk8s/current/args/kube-apiserver &gt; /dev/null) || (echo &quot;--allow-privileged&quot; | sudo tee -a /var/snap/microk8s/current/args/kube-apiserver)
(grep &quot;^--allow-privileged$&quot; /var/snap/microk8s/current/args/kubelet &gt; /dev/null) || (echo &quot;--allow-privileged&quot; | sudo tee -a /var/snap/microk8s/current/args/kubelet)
sudo microk8s.stop
sudo microk8s.start

microk8s.enable ingress
microk8s.enable dns
microk8s.enable storage
sudo snap alias microk8s.kubectl kubectl
microk8s.config &gt; $HOME/.kube/config
helm init
</code></pre><p><a href=https://helm.sh/ target=_blank rel=noopener>Helm</a> es necesario para instalación de Postgres; si vamos a utilizar una BBDD externa, no es necesario.</p><p>Tras esto, ya tenemos el entorno de MicroK8s disponible; ahora nos bajamos AWX y lo configuramos:</p><pre><code class=language-bash># Actualizar e instalar dependencias mínimas
sudo apt update
sudo apt upgrade -y
sudo apt install -y python3-pip vim
pip3 install docker docker-compose --user

# Instalar Ansible, necesario para instalar AWX
sudo add-apt-repository ppa:ansible/ansible -y
sudo apt update
sudo apt install -y ansible

# Nos bajamos la release 9.1.1 de AWX
curl -sLO https://github.com/ansible/awx/archive/9.1.1.tar.gz
tar zxf 9.1.1.tar.gz
cd awx-9.1.1/installer
cp -a inventory{,.original}

# Configuramos el fichero de inventario para que use Kubernetes
sed -i -e 's/#* *kubernetes_context.*/kubernetes_context=microk8s/' inventory
sed -i -e 's/#* *kubernetes_namespace.*/kubernetes_namespace=awx/' inventory

# Y lanzamos la instalación
ansible-playbook -i inventory install.yml
</code></pre><p>Variables interesantes en el fichero <code>inventory</code>:</p><ul><li><code>kubernetes_context</code>: el contexto del cliente de Kubernetes que usaremos para conectarnos al cluster; para MicroK8s, en general será <code>microk8s</code>.</li><li><code>kubernetes_namespace</code>: el <em>namespace</em> del cluster de Kubernetes que se usará para crear todos los elementos de AWX; por defecto es <code>awx</code>.</li><li><code>kubernetes_deployment_name</code>: es un prefijo que se usa para generar los nombres de los recursos dentro del <em>namespace</em>; por defecto es <code>awx</code>.</li><li><code>pg_hostname</code>: es el host remoto donde debemos tener instalado un servidor de Postgres; si esta variable está comentada, el instalador creará un servidor de Postgres en Kubernetes usando Helm; si está definida, se usará el servidor indicado (habrá que configurar adecuadamente el resto de parámetros de conexión a la BBDD: <code>pg_username</code>, <code>pg_password</code>, <code>pg_database</code>, etc.).</li></ul><p>También se pueden especificar las siguientes variables para indicar imágenes y versiones alternativas a las oficiales (por ejemplo, si hemos creado unas propias para añadir software, etc.):</p><ul><li><code>kubernetes_task_version</code> (por defecto: <code>9.1.1</code>)</li><li><code>kubernetes_task_image</code> (por defecto: <code>ansible/awx_task</code>)</li><li><code>kubernetes_web_version</code> (por defecto: <code>9.1.1</code>)</li><li><code>kubernetes_web_image</code> (por defecto: <code>ansible/awx_web</code>)</li></ul><p>Esto nos creará un namespace llamado <code>awx</code> en MicroK8s, y desplegará en él 2 <code>statefulsets</code>: 1 para Postgres y uno para AWX. Cada <code>statefulset/pod</code> de AWX contiene los siguientes contenedores:</p><ul><li>memcached</li><li>rabbitmq</li><li>awx-celery (awx_task)</li><li>awx-web</li></ul><p>Cada vez que se escala el <code>statefulset</code> se crean estos 4 contenedores. Gracias al plugin
<a href=https://github.com/rabbitmq/rabbitmq-peer-discovery-k8s target=_blank rel=noopener><code>rabbitmq_peer_discovery_k8s</code></a> (
<a href=https://github.com/ansible/awx/blob/devel/installer/roles/kubernetes/templates/deployment.yml.j2#L38 target=_blank rel=noopener>aquí</a> se puede ver fichero YAML de configuración) los contenedores de rabbitmq forman un cluster de forma automática.</p><p>Para volver a empezar desde 0, tenemos 2 posibilidades; o bien borrar el <em>namespace</em>:</p><pre><code class=language-bash>kubectl delete namespaces awx
</code></pre><p>O bien con el comando <code>microk8s.reset</code>, aunque con este comando, frecuentemente se queda &ldquo;colgado&rdquo;:</p><pre><code class=language-bash>microk8s.reset
</code></pre><p>Después del reset, es necesario volver a configurar los complementos (dns, storage, ingress), y configurar el cliente:</p><pre><code class=language-bash>microk8s.enable ingress
microk8s.enable dns
microk8s.enable storage
sudo snap alias microk8s.kubectl kubectl
microk8s.config &gt; $HOME/.kube/config
helm init
</code></pre><p>Y podemos lanzar de nuevo la instalación:</p><pre><code class=language-bash>ansible-playbook -i inventory install.yml
</code></pre><p>Si por delante del servidor vamos a poner un balanceador (por ejemplo, un ELB o ALB), debemos configurar el <code>ingress</code> de Nginx para que reenvíe las cabeceras <code>X-Forwarded-*</code>:</p><pre><code class=language-bash>kubectl -n default edit configmaps nginx-load-balancer-microk8s-conf
</code></pre><p>Añadiendo/modificando la sección data con este valor:</p><pre><code class=language-yaml>data:
    use-forwarded-headers: &quot;true&quot;
</code></pre><p>Esto es necesario, por ejemplo, si se usa un balanceador con HTTPS, y configuramos la autentificación de Azure, ya que sin el reenvío de estas cabeceras, AWX se cree que vamos por HTTP en lugar de HTTPS, y la URL de callback para el login de Azure se genera incorrectamente.</p><p>Una vez realizados los pasos de la instalación, lo único que nos queda es acceder a la aplicación, usando el puerto 80 de la máquina, por ejemplo,
<a href=http://localhost target=_blank rel=noopener>http://localhost</a>, que es donde publica los servicios el <em>ingress controller</em> de nginx.</p></div><div class=article-tags><a class="badge badge-light" href=/tags/ansible/>Ansible</a>
<a class="badge badge-light" href=/tags/awx/>AWX</a>
<a class="badge badge-light" href=/tags/kubernetes/>Kubernetes</a>
<a class="badge badge-light" href=/tags/microk8s/>MicroK8s</a></div><div class=share-box aria-hidden=true><ul class=share><li><a href="https://twitter.com/intent/tweet?url=https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/&text=Probando%20Ansible%20AWX%20con%20MicroK8s" target=_blank rel=noopener class=share-btn-twitter><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/sharer.php?u=https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/&t=Probando%20Ansible%20AWX%20con%20MicroK8s" target=_blank rel=noopener class=share-btn-facebook><i class="fab fa-facebook"></i></a></li><li><a href="mailto:?subject=Probando%20Ansible%20AWX%20con%20MicroK8s&body=https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/" target=_blank rel=noopener class=share-btn-email><i class="fas fa-envelope"></i></a></li><li><a href="https://www.linkedin.com/shareArticle?url=https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/&title=Probando%20Ansible%20AWX%20con%20MicroK8s" target=_blank rel=noopener class=share-btn-linkedin><i class="fab fa-linkedin-in"></i></a></li><li><a href="https://web.whatsapp.com/send?text=Probando%20Ansible%20AWX%20con%20MicroK8s%20https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/" target=_blank rel=noopener class=share-btn-whatsapp><i class="fab fa-whatsapp"></i></a></li><li><a href="https://service.weibo.com/share/share.php?url=https://blog.okelet.com/posts/2019/06/probando-ansible-awx-con-microk8s/&title=Probando%20Ansible%20AWX%20con%20MicroK8s" target=_blank rel=noopener class=share-btn-weibo><i class="fab fa-weibo"></i></a></li></ul></div><section id=comments><div id=disqus_thread></div><script>let disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='https://'+"okeletgithubio"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section><div class="article-widget content-widget-hr"><h3>Relacionado</h3><ul><li><a href=/posts/2016/04/instalar-ansible-en-cygwin/>Instalar Ansible en Cygwin</a></li></ul></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/highlight.min.js integrity="sha256-1zu+3BnLYV9LdiY85uXMzii3bdrkelyp37e0ZyTAQh0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/r.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.10/languages/powershell.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=true;</script><script>const isSiteThemeDark=false;</script><script>const search_config={"indexURI":"/index.json","minLength":1,"threshold":0.3};const i18n={"no_results":"No se encontraron resultados","placeholder":"Buscar...","results":"resultados encontrados"};const content_type={'post':"Posts",'project':"Proyectos",'publication':"Publicaciones",'talk':"Charlas"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script id=dsq-count-scr src=https://okeletgithubio.disqus.com/count.js async></script><script src=/js/academic.min.a07fb7ff02bd7120efbadd0dda2cba9f.js></script><div class=container><footer class=site-footer><p class=powered-by><a href=https://creativecommons.org/licenses/by-sa/3.0/>CC BY-SA</a> Juan A. S. 2020 &#183;
Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Citar</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copiar</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Descargar</a><div id=modal-error></div></div></div></div></div></body></html>